# 微博登录配置指南

微博是中国主流的社交媒体平台，适合面向中国用户的应用。

## 前置要求

- 拥有微博账户
- 需要在微博开放平台创建应用
- 需要进行开发者认证

## 配置步骤

### 1. 注册微博开发者

1. 访问 [微博开放平台](https://open.weibo.com/)
2. 使用微博账户登录
3. 完成开发者身份认证（个人或企业）
4. 等待审核通过

### 2. 创建应用

1. 登录微博开放平台
2. 点击 **管理中心** > **我的应用**
3. 点击 **立即接入** 或 **创建应用**
4. 选择应用类型：**网站**
5. 填写应用信息：
   - **应用名称**: `草梅Auth`
   - **应用分类**: 选择合适的分类
   - **应用简介**: 详细描述应用功能
   - **应用网址**: `https://yourdomain.com`
   - **应用备案**: 如有备案信息请填写

### 3. 配置应用设置

创建应用后：

1. 在应用管理页面，选择 **应用信息** > **基本信息**
2. 在 **授权设置** 部分：
   - **授权回调页**: `https://yourdomain.com/api/auth/callback/weibo`
   - **取消授权回调页**: `https://yourdomain.com/api/auth/revoke/weibo`（可选）
3. 在 **应用权限** 部分，申请所需权限：
   - **基础权限**: 获取用户基本信息
   - **邮箱权限**: 获取用户邮箱（需要单独申请）
   - **高级权限**: 根据需要申请

### 4. 获取应用凭据

在 **应用信息** > **基本信息** 页面获取：

- **App Key**: 应用的唯一标识
- **App Secret**: 应用密钥

### 5. 配置环境变量

在项目的 `.env` 文件中添加：

```env
# 微博登录配置
WEIBO_CLIENT_ID=your_weibo_app_key
WEIBO_CLIENT_SECRET=your_weibo_app_secret
WEIBO_SCOPES=email
```

### 6. 重启应用

保存环境变量后，重启应用以使配置生效。

## 权限范围

微博登录可以获取以下用户信息：

### 基础权限
- 用户 ID (uid)
- 用户昵称
- 用户头像
- 性别
- 所在地
- 个人简介
- 关注数/粉丝数
- 微博数

### 扩展权限
- 邮箱地址（需要单独申请）

## 权限申请流程

### 邮箱权限申请

1. 在应用管理页面选择 **权限申请**
2. 申请 **获取用户邮箱权限**
3. 填写申请理由和使用场景
4. 提交申请等待审核

### 高级权限申请

对于一些高级权限（如发微博、私信等）：

1. 需要提供详细的使用说明
2. 可能需要提供应用截图
3. 审核时间较长（1-4 周）

## 测试登录

1. 访问登录页面
2. 点击微博登录按钮
3. 在微博授权页面登录并授权
4. 成功登录后会跳转回应用

## 应用上线

### 开发环境

默认创建的应用处于开发环境：

- 只有开发者本人可以授权登录
- 可以添加测试账户
- 功能受限

### 生产环境

申请上线后：

1. 在应用管理页面点击 **申请上线**
2. 填写上线申请表
3. 提供应用截图和详细说明
4. 等待审核通过
5. 审核通过后所有用户都可以使用

## 常见问题

### 1. redirect_uri_mismatch

**原因**: 回调地址不匹配

**解决方案**:
- 检查微博开放平台中配置的回调地址
- 确保地址完全匹配，包括协议

### 2. invalid_client

**原因**: App Key 或 App Secret 错误

**解决方案**:
- 检查环境变量配置
- 确认应用凭据正确

### 3. unauthorized_client

**原因**: 应用未通过审核或被限制

**解决方案**:
- 检查应用状态
- 确认应用已上线
- 联系微博客服

### 4. insufficient_scope

**原因**: 权限不足

**解决方案**:
- 检查申请的权限范围
- 申请所需的权限
- 等待权限审核通过

## 自定义配置

### 指定权限范围

```javascript
// 请求特定权限
await authClient.signIn.social({
  provider: 'weibo',
  scope: 'email,follow_app_official_microblog'
});
```

### 常用权限范围

```env
# 基础权限（默认）
WEIBO_SCOPES="follow_app_official_microblog"

# 多个权限用逗号分隔
WEIBO_SCOPES=email,follow_app_official_microblog
```

权限说明：
- `email`: 获取用户邮箱
- `follow_app_official_microblog`: 订阅开发者微博

## 用户数据示例

```javascript
// 微博用户信息结构
{
  id: "1234567890",
  screen_name: "用户昵称",
  name: "真实姓名",
  location: "北京",
  description: "个人简介",
  profile_image_url: "头像URL",
  gender: "m", // m:男, f:女, n:未知
  followers_count: 1000,
  friends_count: 500,
  statuses_count: 2000,
  verified: true, // 是否认证用户
  email: "user@example.com" // 需要邮箱权限
}
```

## API 限制

### 调用频率

- 用户授权类接口：150次/小时
- 普通接口：150次/小时/用户
- 高级接口：300-1000次/小时/用户

### 提高限额

1. 完成开发者认证
2. 应用通过审核上线
3. 申请API调用量升级
4. 考虑付费套餐

## 品牌指南

使用微博登录时的建议：

- **颜色**: 使用微博官方橙色 `#FF8140`
- **图标**: 使用微博官方图标
- **文案**: "使用微博账号登录" 或 "微博登录"
- **按钮样式**: 符合微博品牌规范

## 安全注意事项

### 数据保护

1. **敏感信息加密**: 对用户敏感信息进行加密存储
2. **定期清理**: 定期清理不必要的用户数据
3. **权限最小化**: 只申请必要的权限

### 合规要求

1. **实名认证**: 部分功能可能需要用户实名认证
2. **内容审核**: 涉及内容发布的功能需要内容审核
3. **数据安全**: 遵守网络安全法等相关法规

## 相关链接

- [微博开放平台](https://open.weibo.com/)
- [微博 API 文档](https://open.weibo.com/wiki/API)
- [开发者服务协议](https://open.weibo.com/wiki/开发者服务协议)
- [微博登录按钮规范](https://open.weibo.com/wiki/授权机制说明)
